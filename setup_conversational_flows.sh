#!/bin/bash

echo "ğŸš€ Setting up Enhanced AgentHub Database Schema..."

# Check if we have the necessary environment variables
if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_ROLE_KEY" ]; then
    echo "âŒ Error: Please set SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY environment variables"
    echo ""
    echo "You can find these in your Supabase project settings under API:"
    echo "1. Go to https://app.supabase.com"
    echo "2. Select your project"
    echo "3. Go to Settings > API"
    echo "4. Copy the Project URL and service_role key"
    echo ""
    echo "Then run:"
    echo "export SUPABASE_URL='your_project_url'"
    echo "export SUPABASE_SERVICE_ROLE_KEY='your_service_role_key'"
    echo ""
    exit 1
fi

echo "ğŸ—„ï¸  Setting up enhanced database schema for conversational flows..."

echo ""
echo "ğŸ“‹ Manual Setup Instructions:"
echo ""
echo "Since automated SQL execution can be complex, please follow these steps:"
echo ""
echo "1. ï¿½ Copy the enhanced_database_schema.sql content:"
echo "   - File location: $(pwd)/enhanced_database_schema.sql"
echo ""
echo "2. ğŸŒ Go to your Supabase project dashboard:"
echo "   - Visit: https://app.supabase.com"
echo "   - Select your project"
echo ""
echo "3. âš™ï¸  Open the SQL Editor:"
echo "   - Click on 'SQL Editor' in the left sidebar"
echo "   - Click 'New Query'"
echo ""
echo "4. ğŸ“ Paste and execute the schema:"
echo "   - Copy all content from enhanced_database_schema.sql"
echo "   - Paste it into the SQL Editor"
echo "   - Click 'Run' to execute"
echo ""
echo "5. âœ… Verify the tables were created:"
echo "   - Check that these tables exist in your database:"
echo "     â€¢ clients"
echo "     â€¢ interactions"
echo "     â€¢ contracts"
echo "     â€¢ contract_events"
echo "     â€¢ showings"
echo "     â€¢ property_listings"
echo "     â€¢ client_properties"
echo "     â€¢ scheduled_messages"
echo "     â€¢ agent_calendar"
echo ""

# Check if the schema file exists
if [ ! -f "enhanced_database_schema.sql" ]; then
    echo "âŒ Error: enhanced_database_schema.sql not found in current directory"
    echo "Please run this script from the agentHub project root directory"
    exit 1
fi

echo "ğŸ“„ Schema file confirmed at: $(pwd)/enhanced_database_schema.sql"
echo ""

echo "ğŸ‰ After you've run the SQL schema, your database will support:"
echo "   â€¢ ğŸ‘¥ Client management with interaction tracking"
echo "   â€¢ ğŸ“‹ Contract creation and amendment workflows"
echo "   â€¢ ğŸ  Showing scheduling with calendar integration"
echo "   â€¢ ğŸ’¬ Follow-up message generation and scheduling"
echo "   â€¢ ğŸ˜ï¸  Property listings and client property tracking"
echo ""

echo "ğŸš€ Next steps:"
echo ""
echo "1. ğŸ”§ Start your backend server:"
echo "   cd backend && npm start"
echo ""
echo "2. ğŸŒ Start your frontend application:"
echo "   cd frontend && npm start"
echo ""
echo "3. ï¿½ Access the new features:"
echo "   - Login to your AgentHub application"
echo "   - Click the new 'AI Flows' tab"
echo "   - Use the 'Add Sample Data' button for testing"
echo ""
echo "4. ğŸ§ª Test the conversational flows:"
echo "   - Try the Contract Amendment flow"
echo "   - Test Follow-up Generation with your clients"
echo "   - Schedule property showings"
echo ""

echo "ğŸ’¡ Troubleshooting:"
echo "   - If you get permission errors, ensure you're using the service_role key"
echo "   - If auth.uid() errors occur, use the sample data API endpoint instead"
echo "   - Check the browser console for any JavaScript errors"
echo ""

echo "ğŸ“š Documentation:"
echo "   - See CONVERSATIONAL_FLOWS_README.md for detailed usage instructions"
echo "   - Sample data can be added via the API endpoint: POST /api/setup/sample-data"
echo ""
